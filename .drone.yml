kind: pipeline
name: default
type: docker
trigger:
  event:
    - push

steps:
  - name: django-tests
    image: python
    commands:
      - pip install -r requirements.txt
      - pip install -r requirements-dev.txt
      - python manage.py create_secret_key
      - python manage.py test

---

kind: pipeline
type: docker
name: deploy-staging
trigger:
  event:
    - push

steps:
  - name: ssh
    image: appleboy/drone-ssh
    settings:
      host:
        - staging.vulnman.blocki.life
      username: vulnman
      key:
        from_secret: vulnman-ssh-key
      port: 22
      command_timeout: 10m
      script:
        - cd /opt/vulnman
        - git pull
        - python3 manage.py migrate
        - python manage.py collectstatic --noinput
        - sudo /opt/vulnman-helpers/update_blockomat_library.sh
        - python3 manage.py import_vulnerability_templates blockomat_vulnman
